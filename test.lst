     1                                  [BITS 16]
     2 00000000 B8C007                  mov ax,0x07c0
     3 00000003 8ED8                    mov ds,ax
     4                                  
     5                                  
     6                                  enumerate:
     7 00000005 803E[7300]20            	cmp byte [device_no],0x20	; there could be 32 devices in each bus
     8 0000000A 743F                    	je increment_bus_no 		
     9                                  
    10                                  	;   31    30-24      23-16         15-11              10-8              7-2        1-0
    11                                  	; +---+----------+------------+---------------+-----------------+-----------------+----+
    12                                  	; | E | Reserved | Bus Number | Device Number | Function Number | Register Number | 00 |
    13                                  	; +---+----------+------------+---------------+-----------------+-----------------+----+
    14                                  
    15 0000000C 66B800000000            	mov eax,0
    16 00000012 0A06[7200]              	or al,[bus_no]
    17 00000016 66C1E005                	shl eax,5
    18 0000001A 0A06[7300]              	or al,[device_no]
    19 0000001E 66C1E00B                	shl eax,11
    20 00000022 660D00000080            	or eax,0x80000000
    21                                  
    22 00000028 8B16[6E00]              	mov dx,[CONFIG_ADDRESS]
    23 0000002C 66EF                    	out dx,eax
    24 0000002E 8B16[7000]              	mov dx,[CONFIG_DATA]
    25 00000032 66ED                    	in eax,dx
    26                                  
    27 00000034 8306[7600]01            	add word [iteration_count],1
    28 00000039 8006[7300]01            	add byte [device_no],1
    29 0000003E 6683F8FF                	cmp eax,0xFFFFFFFF			; returns 0xFFFFFFFF for non-existing devices
    30 00000042 74C1                    	je enumerate
    31 00000044 8306[7400]01            	add word [device_count],1
    32 00000049 EBBA                    	jmp enumerate
    33                                  increment_bus_no:
    34 0000004B 803E[7200]FF            	cmp byte [bus_no],0xFF		; there could be 256 buses
    35 00000050 740C                    	je end
    36 00000052 8006[7200]01            	add byte [bus_no],1
    37 00000057 C606[7300]00            	mov byte [device_no],0
    38 0000005C EBA7                    	jmp enumerate
    39                                  
    40                                  end:
    41 0000005E 6631C0                  	xor eax,eax
    42 00000061 A1[7400]                	mov word ax,[device_count]
    43 00000064 6631C9                  	xor ecx,ecx
    44 00000067 8B0E[7600]              	mov word cx,[iteration_count]
    45 0000006B F4                      	hlt
    46 0000006C EBF0                    	jmp end
    47                                  
    48                                  
    49                                  	
    50                                  
    51 0000006E F80C                    CONFIG_ADDRESS dw 0x0CF8		; PCI Address Port
    52 00000070 FC0C                    CONFIG_DATA dw 0x0CFC			; PCI Data Port
    53 00000072 00                      bus_no db 0x00
    54 00000073 00                      device_no db 0x00
    55 00000074 0000                    device_count dw 0x0000
    56 00000076 0000                    iteration_count dw 0x000000		; iteration count for debug purposes. 
    57                                  								; should be equal to 8192(0x2000) at the end of enumeration (256 * 32 = 8192)
    58 00000078 00<rept>                times 510-($-$$) db 0x00
    59 000001FE 55                      db 0x55
    60 000001FF AA                      db 0xAA
